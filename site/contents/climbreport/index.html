<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js" type="text/javascript"></script>
<script src="../javascript/tabletop.js" type="text/javascript"></script>
<script>

var uiaa_pattern = /^([3-9])([\+\-])?(?:(?:(\/)[3-9](?:[\+\-])?)?)?$/;

// Grades
// 3+
// 5+/6-
function GetSportGradeFromUIAA(rating) {
  return 3.0 * rating - 7.0;
}


function GetUIAAFromSportGrade(grade) {
  return (grade + 7.0) / 3.0;
}


function ParseSportGradeFromUIAA(uiaa) {
  m = uiaa_pattern.exec(uiaa);
  sport_grade = -1;
  if (m !== null) {
    grade = m[1];
    sport_grade = GetSportGradeFromUIAA(grade);
    if (m[2] != undefined) {
      if (m[2] === '+') {
        sport_grade = sport_grade + 1;
      } else {
        sport_grade = sport_grade - 1;
      }
    }

    if (m[3] != undefined) {
      sport_grade = sport_grade + 0.5;
    }
  }

  return sport_grade;
}


function UIAAFromSportGrade(grade) {
  rating = GetUIAAFromSportGrade(Math.round(grade));
  rating_decimal = Math.floor(Math.round(rating,1));
  slash_symbol = "";
  if (((rating_decimal + 1) - rating) <= 0.5) {
    slash_symbol = "/";
  }
  follow_symbol = "";
  delta_from_previous = GetSportGradeFromUIAA(rating_decimal - 1);
  if (delta_from_previous === 2) {
    follow_symbol = "-";
  } else if (delta_from_previous === 4) {
    follow_symbol = "+";
  }
  // recurse if needed
  follow_on = "";
  if (slash_symbol === "/") {
    follow_on = UIAAFromSportGrade(Math.ceil(Math.round(grade)) + 1);
  }

  str_rating = rating_decimal.toString() + follow_symbol + slash_symbol + follow_on;
  return str_rating;
}


$(function(){
  console.log("Hello");
  var public_url = 
    "https://docs.google.com/spreadsheet/pub?key=0Aik9iNgOEySpdGxObG8ySmNCalJaS2R3YTZpSXFmWlE&single=true&gid=0&output=html";

  Tabletop.init({ 
    key: public_url,
    callback: showInfo,
    simpleSheet: true
  });

  function showInfo(data, tabletop) {
    console.log(data);
    // build a histogram of routes. Only count successful climbs.
    var gradecounts = {};
    for (var i = 0; i < data.length; i++) {
      var obj = data[i];
      var grade = obj.grade.trim();
      var notes = obj.notes.trim();
      
      // Only count successful climbs, ie, those without notes.
      if (notes === "") {
        if (!gradecounts.hasOwnProperty(grade)) {
          gradecounts[grade] = 0;
        }
        gradecounts[grade]++;
      }
    }

    // figure out an ordering for gradecounts
    var sorted_counts = [];
    for (var grade in gradecounts) {
      var obj = {};
      obj.grade = grade;
      obj.count = gradecounts[grade];
      obj.sportgrade = ParseSportGradeFromUIAA(grade);                        
      sorted_counts.push(obj);
    }

    // sort sorted_counts
    sorted_counts.sort(function(a, b) { 
      if (a.sportgrade < b.sportgrade) return -1;
      if (a.sportgrade === b.sportgrade) return 0;
      if (a.sportgrade > b.sportgrade) return 1;
      });

    for (var i = 0; i < sorted_counts.length; i++) {
      var obj = sorted_counts[i];
      var row = "<b>" + obj.grade + "</b>: " + obj.count + "<br/>";
      console.log(row);
      var $row = $(row);
      $row.appendTo("#output");
    }

  }
});

</script>
</head>
<body>

<div id="container"> 
<h1>Climbing gym stats</h1>

<div id="output"> </div> 

</div>

</body>
</html>
